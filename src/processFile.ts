import { Node, factory } from "typescript";
import { Driver } from "ydb-sdk";
import extractVariables from "./extractVariables";
import getExecuteQueryDefinition from "./getExecuteQueryDefinition";
import getImports from "./getImports";

import { Session, TypedValues, Types, withRetries } from "ydb-sdk";
// import getQueryOptions from "./getQueryOptions";
const IMPORTS = [
  TypedValues.name,
  Types.name,
  Driver.name,
  Session.name,
  withRetries.name,
];

const processFile = async (name: string, sql: string, driver: Driver) => {
  const comment = factory.createJSDocComment(
    "This file is generated by ydb-ts-codegen and should not be modified directly"
  );
  let result: Node[] = [comment, getImports(IMPORTS, "ydb-sdk")];
  const variables = await extractVariables(`${name}Variables`, sql, driver);
  const functionDefintion = getExecuteQueryDefinition(name, sql, variables);

  if (variables) {
    result.push(variables.interface);
    result.push(variables.converter);
  }
  result.push(functionDefintion);
  result.push(
    factory.createExportDefault(
      factory.createIdentifier(functionDefintion.name!.text)
    )
  );
  return result;
};

export default processFile;
